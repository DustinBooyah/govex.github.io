<!DOCTYPE html>
<html>

<head>
    <title>Airline Routes</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <style>
    html,
    body,
    #map {
        height: 100%;
        padding: 0;
        margin: 0;
    }
    
    #wrapper {
        position: relative;
    }
    
    #over_map {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 99;
        background-color: rgba(255,255,255,.6);
        padding:10px 10px 20px 10px;
        max-width:250px;
    }
    
    #menu a {
        margin: 15px 5% 0 0;
        float: right;
        vertical-align: baseline;
        width: 35%;
        padding: 5%;
        text-align: center;
        font: lighter 12px "Helvetica", Arial;
        line-height: normal;
        color: #555;
        border-radius: 4px;
        border: none;
        background: rgba(255, 255, 255, 0.55);
        text-decoration: none;
        cursor: pointer;
        box-shadow: rgba(0, 0, 0, 0.65098) 0px 1px 5px 0px;
    }
    
    #menu a.selected,
    #menu a:hover {
        color: #fff;
        background: #FF6600;
        box-shadow: rgba(0, 0, 0, 0.80) 0px 0.5px 2.5px 0px;
    }
    
    #userInput {
        width: 100%;
    }

    #menu p {
        padding: 20px 10px 10px 0px;
        display: inline-block;
        font: lighter 12px "Helvetica", Arial;

    }

    #menu input {
        background-color:rgba(0,0,0,0);
        font-size: 15px;
    }


    
}
    </style>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
</head>

<body>
    <div id="map"></div>
    <div id="over_map">
        <input type="search" id="userInput" placeholder="City, State">
        <div id='menu'>
            <a href="#true" id="true" value=true class="button true selected">Routes To WWC</a>
            <a href="#false" id="false" value=false class="button false">All Routes</a>
            <p>
                <label for="amount">Distance:</label>
                <input type="text" id="amount" readonly style="border:0; color:#f6931f; font-weight:bold;">
            </p>
            <div id="header"></div>
            <div id="slider-range-min" style="width: 100%;"></div>
        </div>
        
    </div>
    <!-- importing cartodb.js -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
    <!-- Draw maps! -->
    <script>
    var sublayers = [];

    function main() {
        // create leaflet map
        var map = L.map('map', {
            zoomControl: false,
            scrollWheelZoom: false,
            center: [39, -98],
            zoomControl: true,
            zoom: 3
        });

        // base layer
        L.tileLayer('http://api.tiles.mapbox.com/v4/mapbox.light/{z}/{x}/{y}@2x.png?access_token=pk.eyJ1IjoicGF6b2xlcyIsImEiOiJDaWVtdExNIn0.AFdKkh9ak6tEnrL8OK2S9w', {
            attribution: 'Mapbox'
        }).addTo(map);

        //routes layer from config.json template loaded separately
        cartodb.createLayer(map, {
                user_name: 'govex',
                type: 'namedmap',
                named_map: {
                    name: "flightpathsql",
                    layers: [{
                        layer_name: "usairroutes_wwc_1",
                        interactivity: "cartodb_id, destinat_2, sourcecity"
                    }]
                }
            })
            .addTo(map)
            .done(function(layer) {
                // uncomment the alert to confirm sublayer additions
                for (var i = 0; i < layer.getSubLayerCount(); i++) {
                    sublayers[i] = layer.getSubLayer(i);
                    //alert("Sublayer #" + i + "was added");

                }

                //set city variable from input
                lon = "-96.6167";
                lat = "49.2833";
                maxd = "20"
                mind = "0"
                wwc_limit = "and a.destinatio in (select c.nearest_airport from wwcforrouting_3 c)"
                layer.setParams({
                    'lon': lon,
                    'lat': lat,
                    'maxd': maxd,
                    'mind': mind
                        //'wwc_limit': wwc_limit
                });




                $('.button').click(function() {
                    $('.button').removeClass('selected');
                    $(this).addClass('selected');
                    if ($(this).is('#false')) {
                        wwc_limit = ""
                    } else {
                        wwc_limit = "a.destinatio in (select c.nearest_airport from wwcforrouting_3 c)"
                    };
                    var geocoder = new google.maps.Geocoder();
                    geocoder.geocode({
                        'address': document.getElementById("userInput").value
                    }, function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            lon = String(results[0].geometry.location.lng());
                            lat = String(results[0].geometry.location.lat());

                            layer.setParams({
                                'lon': lon,
                                'lat': lat,
                                'maxd': maxd,
                                'mind': mind,
                                'wwc_limit': wwc_limit
                            });
                        } else {
                            alert("OH NOEZ " + status);
                        }
                    });
                });


                $("#userInput").on('search', function() {

                    var geocoder = new google.maps.Geocoder();
                    geocoder.geocode({
                        'address': document.getElementById("userInput").value
                    }, function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            lon = String(results[0].geometry.location.lng());
                            lat = String(results[0].geometry.location.lat());

                            layer.setParams({
                                'lon': lon,
                                'lat': lat,
                                'maxd': maxd,
                                'mind': mind,
                                'wwc_limit': wwc_limit
                            });
                        } else {
                            alert("OH NOEZ " + status);
                        }
                    });

                });

                $(function() {
                    $("#slider-range-min").slider({
                        range: "min",
                        value: 2,
                        min: 0,
                        max: 10,
                        slide: function(event, ui) {
                            $("#amount").val((ui.value * 10) + " miles");
                            // scale to [0,1] from [0,100]
                            maxd = String($("#slider-range-min").slider("value") * 10);
                            var geocoder = new google.maps.Geocoder();
                            geocoder.geocode({
                                'address': document.getElementById("userInput").value
                            }, function(results, status) {
                                if (status == google.maps.GeocoderStatus.OK) {
                                    lon = String(results[0].geometry.location.lng());
                                    lat = String(results[0].geometry.location.lat());

                                    layer.setParams({
                                        'lon': lon,
                                        'lat': lat,
                                        'maxd': maxd,
                                        'mind': mind,
                                        'wwc_limit': wwc_limit
                                    });
                                } else {
                                    alert("OH NOEZ " + status);
                                }
                            });
                        }
                    });
                    $("#amount").val($("#slider-range-min").slider("value") * 10 + " miles");
                });


                //enable interactions
                layer.getSubLayer(0).setInteraction(true);

                // on mouseover
                layer.getSubLayer(0).on('featureOver', function(e, pos, pixel, data) {
                    // print data to console log
                    console.log("Event #" + data.cartodb_id);
                });

                // show infowindows on click
                cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['cartodb_id', 'destinat_2', 'sourcecity']);
            })
            .error(function(layer) {
                console.log("some error occurred");
            });;


        cartodb.createLayer(map, 'https://govex.cartodb.com/api/v2/viz/17b5690c-20f2-11e5-b0ee-0e853d047bba/viz.json')
            .addTo(map)
            .done(function(layer) {
                // uncomment the alert to confirm sublayer additions
                for (var i = 0; i < layer.getSubLayerCount(); i++) {
                    sublayers[i] = layer.getSubLayer(i);
                    //alert("Sublayer #" + i + "was added");

                }
            })
            .error(function(layer) {
                console.log("some error occurred");
            });

    }


    window.onload = main;
    </script>
</body>

</html>
